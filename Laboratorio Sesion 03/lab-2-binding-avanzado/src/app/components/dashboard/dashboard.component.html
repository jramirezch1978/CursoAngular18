<!-- 📊 LAB 2: BINDING AVANZADO Y MANEJO DE EVENTOS -->
<!-- DASHBOARD EJECUTIVO DE PROVIAS -->

<div class="dashboard-container" [ngClass]="getThemeClasses()">

  <!-- 🎛️ BARRA DE HERRAMIENTAS SUPERIOR -->
  <header class="dashboard-toolbar">
    
    <!-- 🔍 SECCIÓN DE BÚSQUEDA -->
    <div class="search-section">
      <div class="search-input-group">
        <input
          type="text"
          [(ngModel)]="searchTerm"
          (input)="onSearchChange()"
          (keydown)="onSearchKeydown($event)"
          placeholder="Buscar widgets, proyectos, equipos..."
          class="search-input"
          [class.has-value]="searchTerm.length > 0">
        
        <button
          type="button"
          (click)="clearSearch()"
          class="search-clear-btn"
          [style.opacity]="searchTerm.length > 0 ? '1' : '0'"
          title="Limpiar búsqueda">
          ❌
        </button>
      </div>
      
      <div class="search-info">
        <small>💡 Atajos: Ctrl+F (Fullscreen) | Ctrl+D (Cambiar Tema) | Escape (Salir)</small>
      </div>
    </div>

    <!-- 🎮 CONTROLES DE VISTA -->
    <div class="view-controls">
      
      <!-- 🎨 SELECTOR DE TEMA -->
      <div class="theme-selector">
        <select
          [(ngModel)]="selectedTheme"
          (change)="changeTheme(selectedTheme)"
          class="theme-select">
          @for (theme of themes; track theme.value) {
            <option [value]="theme.value">{{ theme.label }}</option>
          }
        </select>
      </div>

      <!-- 🖥️ FULLSCREEN -->
      <button
        type="button"
        (click)="toggleFullscreen()"
        class="control-btn fullscreen-btn"
        [class.active]="isFullscreen"
        title="Pantalla completa (Ctrl+F)">
        {{ isFullscreen ? '🔲' : '⛶' }}
      </button>

      <!-- 🔄 TIEMPO ACTUAL -->
      <div class="current-time">
        {{ currentTime | date:'HH:mm:ss' }}
      </div>

    </div>

  </header>

  <!-- 📊 INDICADORES DE ESTADO GLOBAL -->
  <section class="status-bar">
    
    <!-- 🔌 ESTADO DE CONEXIÓN -->
    <div class="connection-status">
      <span class="status-indicator online"></span>
      <span>En línea</span>
    </div>

    <!-- ⏳ INDICADOR DE CARGA -->
    @if (isLoading) {
      <div class="loading-indicator">
        <span class="loading-spinner"></span>
        <span>Actualizando datos...</span>
      </div>
    }

    <!-- 🚨 CONTADOR DE ALERTAS -->
    <div class="alerts-counter"
      [ngClass]="{
        'has-critical': alertsData.critical > 0,
        'has-warnings': alertsData.warning > 0
      }">
      🚨 {{ alertsData.critical + alertsData.warning + alertsData.info }} alertas
    </div>

  </section>

  <!-- 🏗️ CONTENEDOR PRINCIPAL DEL DASHBOARD -->
  <main class="dashboard-main">

    <!-- 🎯 WIDGETS DINÁMICOS -->
    <div class="widgets-grid">
      @for (widget of widgets; track widget.id) {
        
        <!-- 📦 WIDGET CONTAINER -->
        <article
          class="widget-container"
          [ngClass]="getWidgetClasses(widget)"
          [ngStyle]="getWidgetStyles(widget)"
          [attr.data-widget-id]="widget.id"
          [attr.data-widget-type]="widget.type"
          (click)="onWidgetClick(widget, $event)"
          (mouseenter)="onWidgetHover(widget, true)"
          (mouseleave)="onWidgetHover(widget, false)"
          tabindex="0">

          <!-- 📋 WIDGET HEADER -->
          <header class="widget-header">
            
            <div class="widget-title-section">
              <h3 class="widget-title">{{ widget.title }}</h3>
              <span class="widget-type-badge">{{ widget.type | titlecase }}</span>
            </div>

            <!-- 🎛️ WIDGET CONTROLS -->
            <div class="widget-controls">
              <button
                type="button"
                (click)="refreshWidget(widget); $event.stopPropagation()"
                class="widget-action-btn"
                [disabled]="isLoading"
                title="Actualizar widget">
                🔄
              </button>
            </div>

          </header>

          <!-- 📊 WIDGET CONTENT -->
          <div class="widget-content">

            <!-- 📈 METRIC WIDGET -->
            @if (widget.type === 'metric') {
              <div class="metric-widget">
                <div class="metric-value"
                  [ngStyle]="{
                    'color': widget.data.trend === 'up' ? '#10b981' : 
                             widget.data.trend === 'down' ? '#ef4444' : '#6b7280',
                    'font-size': widget.size.width > 4 ? '3rem' : '2rem'
                  }">
                  {{ widget.data.value | number }}
                </div>
                
                <div class="metric-change"
                  [ngClass]="{
                    'trend-up': widget.data.trend === 'up',
                    'trend-down': widget.data.trend === 'down',
                    'trend-stable': widget.data.trend === 'stable'
                  }">
                  {{ widget.data.change }}
                  @switch (widget.data.trend) {
                    @case ('up') { ↗️ }
                    @case ('down') { ↘️ }
                    @default { ➡️ }
                  }
                </div>
              </div>
            }

            <!-- 📊 CHART WIDGET -->
            @if (widget.type === 'chart') {
              <div class="chart-widget">
                <div class="chart-header">
                  <span class="chart-label">Progreso del Presupuesto</span>
                  <span class="chart-percentage"
                    [ngStyle]="{
                      'color': widget.data.percentage >= 90 ? '#10b981' :
                               widget.data.percentage >= 70 ? '#f59e0b' : '#3b82f6'
                    }">
                    {{ widget.data.percentage | percent:'1.1-1' }}
                  </span>
                </div>
                
                <div class="progress-bar-container">
                  <div class="progress-bar"
                    [ngStyle]="{
                      'width': widget.data.percentage + '%',
                      'background-color': widget.data.percentage >= 90 ? '#10b981' :
                                          widget.data.percentage >= 70 ? '#f59e0b' : '#3b82f6'
                    }">
                  </div>
                </div>

                <div class="chart-details">
                  <div class="chart-amounts">
                    <span>{{ widget.data.used | currency:'PEN':'symbol':'1.0-0' }}</span>
                    <span>de {{ widget.data.total | currency:'PEN':'symbol':'1.0-0' }}</span>
                  </div>
                </div>
              </div>
            }

            <!-- 🚨 ALERT WIDGET -->
            @if (widget.type === 'alert') {
              <div class="alert-widget">
                <div class="alert-summary">
                  
                  <div class="alert-item critical"
                    [ngClass]="{ 'has-alerts': widget.data.critical > 0 }">
                    <span class="alert-count">{{ widget.data.critical }}</span>
                    <span class="alert-label">Críticas</span>
                  </div>

                  <div class="alert-item warning"
                    [ngClass]="{ 'has-alerts': widget.data.warning > 0 }">
                    <span class="alert-count">{{ widget.data.warning }}</span>
                    <span class="alert-label">Advertencias</span>
                  </div>

                  <div class="alert-item info"
                    [ngClass]="{ 'has-alerts': widget.data.info > 0 }">
                    <span class="alert-count">{{ widget.data.info }}</span>
                    <span class="alert-label">Información</span>
                  </div>

                </div>
              </div>
            }

            <!-- 🟢 STATUS WIDGET -->
            @if (widget.type === 'status') {
              <div class="status-widget">
                <div class="status-grid">
                  
                  <div class="status-item operational">
                    <div class="status-icon">🟢</div>
                    <div class="status-count">{{ widget.data.operational }}</div>
                    <div class="status-label">Operativo</div>
                  </div>

                  <div class="status-item maintenance">
                    <div class="status-icon">🟡</div>
                    <div class="status-count">{{ widget.data.maintenance }}</div>
                    <div class="status-label">Mantenimiento</div>
                  </div>

                  <div class="status-item repair">
                    <div class="status-icon">🔴</div>
                    <div class="status-count">{{ widget.data.repair }}</div>
                    <div class="status-label">Reparación</div>
                  </div>

                </div>
                
                <div class="status-total">
                  Total: {{ widget.data.operational + widget.data.maintenance + widget.data.repair }} equipos
                </div>
              </div>
            }

          </div>

          <!-- 📊 WIDGET FOOTER -->
          <footer class="widget-footer">
            <div class="widget-meta">
              <span class="last-update">
                Actualizado: {{ currentTime | date:'HH:mm:ss' }}
              </span>
            </div>
          </footer>

        </article>

      }
    </div>

  </main>

  <!-- 📚 DOCUMENTACIÓN DE BINDING AVANZADO -->
  <aside class="binding-docs">
    <h3>📚 Técnicas Demostradas</h3>
    
    <div class="docs-grid">
      
      <!-- NgClass -->
      <div class="doc-card">
        <h4>🎨 NgClass</h4>
        <p>Aplicación de múltiples clases CSS dinámicas</p>
        <div class="code-example">
          <code>[ngClass]="getWidgetClasses(widget)"</code>
        </div>
        <div class="demo-section">
          <div [ngClass]="{ 'demo-active': isFullscreen, 'demo-inactive': !isFullscreen }">
            Estado: {{ isFullscreen ? 'Fullscreen' : 'Normal' }}
          </div>
        </div>
      </div>

      <!-- NgStyle -->
      <div class="doc-card">
        <h4>🎭 NgStyle</h4>
        <p>Estilos dinámicos calculados en tiempo real</p>
        <div class="code-example">
          <code>[ngStyle]="getWidgetStyles(widget)"</code>
        </div>
        <div class="demo-section">
          <div [ngStyle]="{ 'background-color': primaryColor, 'color': 'white', 'padding': '1rem', 'border-radius': '8px' }">
            Color dinámico: {{ selectedTheme }}
          </div>
        </div>
      </div>

      <!-- HostListener -->
      <div class="doc-card">
        <h4>🎧 HostListener</h4>
        <p>Eventos globales del DOM y ventana</p>
        <div class="code-example">
          <code>@HostListener('window:keydown')</code>
        </div>
        <div class="demo-section">
          <p>Presiona Ctrl+F o Ctrl+D para probar</p>
          <p>Última tecla: <span id="last-key">-</span></p>
        </div>
      </div>

      <!-- HostBinding -->
      <div class="doc-card">
        <h4>🎯 HostBinding</h4>
        <p>Binding de propiedades del elemento host</p>
        <div class="code-example">
          <code>@HostBinding('class.fullscreen')</code>
        </div>
        <div class="demo-section">
          <p>Modo: {{ isFullscreen ? 'Fullscreen' : 'Normal' }}</p>
          <p>Tema: {{ isDarkTheme ? 'Oscuro' : 'Claro' }}</p>
        </div>
      </div>

    </div>
  </aside>

</div>