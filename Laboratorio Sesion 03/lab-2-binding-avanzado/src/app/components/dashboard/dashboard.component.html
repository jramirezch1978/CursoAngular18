<!-- ğŸ“Š LAB 2: BINDING AVANZADO Y MANEJO DE EVENTOS -->
<!-- DASHBOARD EJECUTIVO DE PROVIAS -->

<div class="dashboard-container" [ngClass]="getGridClasses()">

  <!-- ğŸ›ï¸ BARRA DE HERRAMIENTAS SUPERIOR -->
  <header class="dashboard-toolbar">
    
    <!-- ğŸ” SECCIÃ“N DE BÃšSQUEDA -->
    <div class="search-section">
      <div class="search-input-group">
        <input
          type="text"
          [(ngModel)]="searchTerm"
          (input)="onSearchChange()"
          (keydown)="onSearchKeydown($event)"
          placeholder="Buscar widgets, proyectos, equipos..."
          class="search-input"
          [class.has-value]="searchTerm.length > 0"
          [attr.aria-label]="'Buscar en dashboard. ' + (searchTerm ? 'TÃ©rmino actual: ' + searchTerm : 'Campo vacÃ­o')">
        
        <button
          type="button"
          (click)="clearSearch()"
          class="search-clear-btn"
          [style.opacity]="searchTerm.length > 0 ? '1' : '0'"
          [attr.aria-label]="'Limpiar bÃºsqueda'"
          tabindex="0">
          âŒ
        </button>
      </div>
      
      <div class="search-shortcuts">
        <small>ğŸ’¡ Atajos: Ctrl+F (Fullscreen) | Ctrl+D (Tema) | Ctrl+R (Actualizar)</small>
      </div>
    </div>

    <!-- ğŸ® CONTROLES DE VISTA -->
    <div class="view-controls">
      
      <!-- ğŸ¨ SELECTOR DE TEMA -->
      <div class="theme-selector">
        <button
          type="button"
          (click)="toggleTheme()"
          class="theme-btn"
          [ngClass]="{
            'theme-light': currentTheme === 'light',
            'theme-dark': currentTheme === 'dark',
            'theme-contrast': currentTheme === 'high-contrast'
          }"
          [attr.aria-label]="'Cambiar tema. Actual: ' + currentTheme"
          [title]="'Tema actual: ' + currentTheme">
          @if (currentTheme === 'light') {
            â˜€ï¸
          } @else if (currentTheme === 'dark') {
            ğŸŒ™
          } @else {
            ğŸ”†
          }
        </button>
      </div>

      <!-- ğŸ–¥ï¸ FULLSCREEN -->
      <button
        type="button"
        (click)="toggleFullscreen()"
        class="control-btn fullscreen-btn"
        [class.active]="state?.isFullscreen"
        [attr.aria-label]="(state?.isFullscreen ? 'Salir de' : 'Entrar en') + ' pantalla completa'"
        title="Pantalla completa (Ctrl+F)">
        {{ state?.isFullscreen ? 'ğŸ”²' : 'â›¶' }}
      </button>

      <!-- âš™ï¸ CONFIGURACIÃ“N -->
      <button
        type="button"
        (click)="openConfigPanel()"
        class="control-btn config-btn config-trigger"
        [class.active]="isConfigPanelOpen"
        aria-label="Abrir panel de configuraciÃ³n"
        title="ConfiguraciÃ³n">
        âš™ï¸
      </button>

      <!-- ğŸ”„ ACTUALIZAR -->
      <button
        type="button"
        (click)="refreshAllWidgets()"
        class="control-btn refresh-btn"
        [disabled]="state?.isLoading"
        aria-label="Actualizar todos los widgets"
        title="Actualizar todo (Ctrl+R)">
        ğŸ”„
      </button>

    </div>

  </header>

  <!-- ğŸ“Š INDICADORES DE ESTADO GLOBAL -->
  <section class="status-bar" 
    [ngStyle]="{
      'background-color': state?.isOffline ? '#fee2e2' : 'transparent',
      'border-bottom': state?.isOffline ? '2px solid #fca5a5' : 'none'
    }">
    
    <!-- ğŸ”Œ ESTADO DE CONEXIÃ“N -->
    <div class="connection-status"
      [ngClass]="{
        'status-online': !state?.isOffline,
        'status-offline': state?.isOffline
      }">
      <span class="status-indicator"
        [style.background-color]="state?.isOffline ? '#ef4444' : '#10b981'">
      </span>
      <span>{{ state?.isOffline ? 'Sin conexiÃ³n' : 'En lÃ­nea' }}</span>
    </div>

    <!-- ğŸ“± INDICADOR MÃ“VIL -->
    @if (state?.isMobile) {
      <div class="mobile-indicator">
        ğŸ“± Vista mÃ³vil
      </div>
    }

    <!-- â³ INDICADOR DE CARGA -->
    @if (state?.isLoading) {
      <div class="loading-indicator">
        <span class="loading-spinner"></span>
        <span>Actualizando datos...</span>
      </div>
    }

    <!-- ğŸš¨ CONTADOR DE ALERTAS -->
    @if (alerts$ | async; as alerts) {
      <div class="alerts-counter"
        [ngClass]="{
          'has-critical': alerts.some(a => a.severity === 'critical'),
          'has-warnings': alerts.some(a => a.severity === 'warning')
        }"
        (click)="openConfigPanel()"
        role="button"
        tabindex="0"
        [attr.aria-label]="'Alertas activas: ' + alerts.length">
        
        ğŸš¨ {{ alerts.length }} alertas
        
        @if (alerts.some(a => a.severity === 'critical')) {
          <span class="critical-pulse"></span>
        }
      </div>
    }

  </section>

  <!-- ğŸ—ï¸ CONTENEDOR PRINCIPAL DEL DASHBOARD -->
  <main class="dashboard-main" 
    [ngStyle]="getGridStyles()"
    [attr.aria-label]="'Dashboard con ' + (widgets$ | async)?.length + ' widgets'">

    <!-- ğŸ¯ WIDGETS DINÃMICOS -->
    @if (widgets$ | async; as widgets) {
      @for (widget of widgets; track widget.id) {
        
        <!-- ğŸ“¦ WIDGET CONTAINER -->
        <article
          class="widget-container"
          [ngClass]="getWidgetClasses(widget)"
          [ngStyle]="getWidgetStyles(widget)"
          [attr.data-widget-id]="widget.id"
          [attr.data-widget-type]="widget.type"
          [attr.aria-label]="widget.title + '. Estado: ' + widget.status"
          [attr.role]="'region'"
          [attr.tabindex]="0"
          (click)="onWidgetClick(widget, $event)"
          (dblclick)="onWidgetDoubleClick(widget)"
          (mouseenter)="onWidgetMouseEnter(widget)"
          (mouseleave)="onWidgetMouseLeave(widget)"
          (focus)="onWidgetFocus(widget)"
          (keydown)="onWidgetKeydown(widget, $event)">

          <!-- ğŸ“‹ WIDGET HEADER -->
          @if (widget.config.showHeader) {
            <header class="widget-header"
              [ngClass]="{
                'header-compact': widget.size.width <= 3,
                'header-minimal': !widget.config.showFooter
              }">
              
              <div class="widget-title-section">
                <h3 class="widget-title">{{ widget.title }}</h3>
                
                <!-- ğŸ·ï¸ WIDGET TYPE BADGE -->
                <span class="widget-type-badge"
                  [ngClass]="'badge-' + widget.type">
                  {{ getWidgetTypeLabel(widget.type) }}
                </span>
              </div>

              <!-- ğŸ›ï¸ WIDGET CONTROLS -->
              <div class="widget-controls">
                
                <!-- ğŸ“Š STATUS INDICATOR -->
                <div class="widget-status"
                  [ngClass]="'status-' + widget.status"
                  [title]="'Estado: ' + widget.status">
                  @switch (widget.status) {
                    @case ('loading') {
                      <span class="status-spinner">â³</span>
                    }
                    @case ('error') {
                      <span class="status-error">âŒ</span>
                    }
                    @case ('offline') {
                      <span class="status-offline">ğŸ“¡</span>
                    }
                    @case ('updating') {
                      <span class="status-updating">ğŸ”„</span>
                    }
                    @default {
                      <span class="status-ready">âœ…</span>
                    }
                  }
                </div>

                <!-- ğŸ”„ REFRESH BUTTON -->
                <button
                  type="button"
                  (click)="refreshWidget(widget.id); $event.stopPropagation()"
                  class="widget-action-btn"
                  [disabled]="widget.status === 'loading' || widget.status === 'updating'"
                  [attr.aria-label]="'Actualizar ' + widget.title"
                  title="Actualizar widget">
                  ğŸ”„
                </button>

                <!-- âš™ï¸ CONFIG BUTTON -->
                <button
                  type="button"
                  (click)="openWidgetConfig(widget.id); $event.stopPropagation()"
                  class="widget-action-btn config-trigger"
                  [attr.aria-label]="'Configurar ' + widget.title"
                  title="Configurar widget">
                  âš™ï¸
                </button>

                <!-- ğŸ—‘ï¸ REMOVE BUTTON -->
                <button
                  type="button"
                  (click)="removeWidget(widget.id); $event.stopPropagation()"
                  class="widget-action-btn remove-btn"
                  [attr.aria-label]="'Eliminar ' + widget.title"
                  title="Eliminar widget">
                  ğŸ—‘ï¸
                </button>

              </div>

            </header>
          }

          <!-- ğŸ“Š WIDGET CONTENT -->
          <div class="widget-content"
            [ngClass]="{
              'content-loading': widget.status === 'loading',
              'content-error': widget.status === 'error',
              'content-compact': widget.size.width <= 3 || widget.size.height <= 2
            }">

            <!-- ğŸ“ˆ METRIC WIDGET -->
            @if (widget.type === 'metric') {
              <div class="metric-widget">
                <div class="metric-value"
                  [ngStyle]="{
                    'color': widget.data.trend === 'up' ? '#10b981' : 
                             widget.data.trend === 'down' ? '#ef4444' : '#6b7280',
                    'font-size': widget.size.width > 4 ? '3rem' : '2rem'
                  }">
                  {{ widget.data.value | number }}
                </div>
                
                <div class="metric-change"
                  [ngClass]="{
                    'trend-up': widget.data.trend === 'up',
                    'trend-down': widget.data.trend === 'down',
                    'trend-stable': widget.data.trend === 'stable'
                  }">
                  {{ widget.data.change }}
                  @switch (widget.data.trend) {
                    @case ('up') { â†—ï¸ }
                    @case ('down') { â†˜ï¸ }
                    @default { â¡ï¸ }
                  }
                </div>
              </div>
            }

            <!-- ğŸ“Š PROGRESS WIDGET -->
            @if (widget.type === 'progress') {
              <div class="progress-widget">
                <div class="progress-header">
                  <span class="progress-label">Progreso</span>
                  <span class="progress-percentage"
                    [ngStyle]="{
                      'color': widget.data.percentage >= 90 ? '#10b981' :
                               widget.data.percentage >= 70 ? '#f59e0b' : '#3b82f6'
                    }">
                    {{ formatPercentage(widget.data.percentage) }}
                  </span>
                </div>
                
                <div class="progress-bar-container">
                  <div class="progress-bar"
                    [ngStyle]="{
                      'width': widget.data.percentage + '%',
                      'background-color': widget.data.percentage >= 90 ? '#10b981' :
                                          widget.data.percentage >= 70 ? '#f59e0b' : '#3b82f6',
                      'transition': 'width 0.5s ease-in-out'
                    }">
                  </div>
                </div>

                <div class="progress-details">
                  <div class="progress-amounts">
                    <span>{{ formatCurrency(widget.data.used || 0) }}</span>
                    <span>de {{ formatCurrency(widget.data.total || 0) }}</span>
                  </div>
                </div>
              </div>
            }

            <!-- ğŸš¨ ALERT WIDGET -->
            @if (widget.type === 'alert') {
              <div class="alert-widget">
                <div class="alert-summary">
                  
                  <div class="alert-item critical"
                    [ngClass]="{ 'has-alerts': widget.data.critical > 0 }">
                    <span class="alert-count">{{ widget.data.critical }}</span>
                    <span class="alert-label">CrÃ­ticas</span>
                  </div>

                  <div class="alert-item warning"
                    [ngClass]="{ 'has-alerts': widget.data.warning > 0 }">
                    <span class="alert-count">{{ widget.data.warning }}</span>
                    <span class="alert-label">Advertencias</span>
                  </div>

                  <div class="alert-item info"
                    [ngClass]="{ 'has-alerts': widget.data.info > 0 }">
                    <span class="alert-count">{{ widget.data.info }}</span>
                    <span class="alert-label">InformaciÃ³n</span>
                  </div>

                </div>

                <!-- ğŸ”” TREND INDICATOR -->
                @if (widget.data.trend) {
                  <div class="alert-trend"
                    [ngClass]="'trend-' + widget.data.trend">
                    Tendencia: {{ widget.data.trend }}
                  </div>
                }
              </div>
            }

            <!-- ğŸŸ¢ STATUS WIDGET -->
            @if (widget.type === 'status') {
              <div class="status-widget">
                <div class="status-grid">
                  
                  <div class="status-item operational">
                    <div class="status-icon">ğŸŸ¢</div>
                    <div class="status-count">{{ widget.data.operational }}</div>
                    <div class="status-label">Operativo</div>
                  </div>

                  <div class="status-item maintenance">
                    <div class="status-icon">ğŸŸ¡</div>
                    <div class="status-count">{{ widget.data.maintenance }}</div>
                    <div class="status-label">Mantenimiento</div>
                  </div>

                  <div class="status-item repair">
                    <div class="status-icon">ğŸ”´</div>
                    <div class="status-count">{{ widget.data.repair }}</div>
                    <div class="status-label">ReparaciÃ³n</div>
                  </div>

                  <div class="status-item idle">
                    <div class="status-icon">âšª</div>
                    <div class="status-count">{{ widget.data.idle }}</div>
                    <div class="status-label">Inactivo</div>
                  </div>

                </div>
                
                <div class="status-total">
                  Total: {{ widget.data.total }} equipos
                </div>
              </div>
            }

            <!-- ğŸ“ˆ CHART WIDGET -->
            @if (widget.type === 'chart') {
              <div class="chart-widget">
                <div class="chart-placeholder"
                  [ngStyle]="{
                    'height': (widget.size.height * 80) + 'px',
                    'background': 'linear-gradient(45deg, #f3f4f6, #e5e7eb)'
                  }">
                  
                  <!-- SimulaciÃ³n de grÃ¡fico -->
                  <div class="chart-bars">
                    @if (widget.data.regions && widget.data.progress) {
                      @for (region of widget.data.regions; track $index; let i = $index) {
                        <div class="chart-bar"
                          [ngStyle]="{
                            'height': widget.data.progress[i] + '%',
                            'background-color': 'hsl(' + (i * 60) + ', 70%, 50%)',
                            'animation-delay': (i * 0.1) + 's'
                          }"
                          [title]="region + ': ' + widget.data.progress[i] + '%'">
                        </div>
                      }
                    }
                  </div>

                  <div class="chart-legend">
                    @if (widget.data.regions) {
                      @for (region of widget.data.regions; track $index; let i = $index) {
                        <span class="legend-item"
                          [ngStyle]="{
                            'color': 'hsl(' + (i * 60) + ', 70%, 40%)'
                          }">
                          {{ region }}
                        </span>
                      }
                    }
                  </div>
                </div>
              </div>
            }

            <!-- ğŸ”„ LOADING STATE -->
            @if (widget.status === 'loading') {
              <div class="widget-loading-overlay">
                <div class="loading-spinner"></div>
                <span>Cargando datos...</span>
              </div>
            }

            <!-- âŒ ERROR STATE -->
            @if (widget.status === 'error') {
              <div class="widget-error-overlay">
                <div class="error-icon">âŒ</div>
                <span>Error al cargar datos</span>
                <button 
                  type="button"
                  (click)="refreshWidget(widget.id)"
                  class="retry-btn">
                  Reintentar
                </button>
              </div>
            }

          </div>

          <!-- ğŸ“Š WIDGET FOOTER -->
          @if (widget.config.showFooter) {
            <footer class="widget-footer">
              <div class="widget-meta">
                <span class="last-update">
                  Actualizado: {{ widget.lastUpdate | date:'HH:mm:ss' }}
                </span>
                
                @if (widget.config.autoRefresh) {
                  <span class="auto-refresh-indicator">ğŸ”„ Auto</span>
                }
              </div>
            </footer>
          }

        </article>

      } @empty {
        <!-- ğŸ˜” ESTADO VACÃO -->
        <div class="empty-dashboard">
          <div class="empty-icon">ğŸ“Š</div>
          <h3>Dashboard vacÃ­o</h3>
          <p>Agrega widgets para comenzar a monitorear tus proyectos</p>
          <button
            type="button"
            (click)="openConfigPanel()"
            class="add-widget-btn">
            â• Agregar Widget
          </button>
        </div>
      }
    }

  </main>

  <!-- âš™ï¸ PANEL DE CONFIGURACIÃ“N LATERAL -->
  @if (isConfigPanelOpen) {
    <aside class="config-panel"
      [ngClass]="{ 'panel-open': isConfigPanelOpen }"
      role="dialog"
      aria-labelledby="config-panel-title"
      [attr.aria-hidden]="!isConfigPanelOpen">

      <!-- ğŸ“‹ HEADER DEL PANEL -->
      <header class="config-panel-header">
        <h2 id="config-panel-title">âš™ï¸ ConfiguraciÃ³n</h2>
        <button
          type="button"
          (click)="closeConfigPanel()"
          class="close-panel-btn"
          aria-label="Cerrar panel de configuraciÃ³n">
          âŒ
        </button>
      </header>

      <!-- ğŸ“Š CONTENIDO DEL PANEL -->
      <div class="config-panel-content">

        <!-- â• AGREGAR WIDGETS -->
        <section class="config-section">
          <h3>â• Agregar Widgets</h3>
          <div class="widget-types-grid">
            @for (widgetType of availableWidgetTypes; track widgetType.type) {
              <button
                type="button"
                (click)="addWidget(widgetType.type)"
                class="widget-type-btn"
                [attr.aria-label]="'Agregar widget de tipo ' + widgetType.label">
                <span class="widget-type-icon">{{ widgetType.icon }}</span>
                <span class="widget-type-label">{{ widgetType.label }}</span>
              </button>
            }
          </div>
        </section>

        <!-- ğŸ¨ CONFIGURACIÃ“N DE TEMA -->
        <section class="config-section">
          <h3>ğŸ¨ Tema</h3>
          <div class="theme-options">
            <label class="theme-option">
              <input
                type="radio"
                name="theme"
                value="light"
                [checked]="currentTheme === 'light'"
                (change)="currentTheme = 'light'; updateThemeColors()">
              <span>â˜€ï¸ Claro</span>
            </label>
            <label class="theme-option">
              <input
                type="radio"
                name="theme"
                value="dark"
                [checked]="currentTheme === 'dark'"
                (change)="currentTheme = 'dark'; updateThemeColors()">
              <span>ğŸŒ™ Oscuro</span>
            </label>
            <label class="theme-option">
              <input
                type="radio"
                name="theme"
                value="high-contrast"
                [checked]="currentTheme === 'high-contrast'"
                (change)="currentTheme = 'high-contrast'; updateThemeColors()">
              <span>ğŸ”† Alto Contraste</span>
            </label>
          </div>
        </section>

        <!-- ğŸš¨ ALERTAS ACTIVAS -->
        @if (alerts$ | async; as alerts) {
          <section class="config-section">
            <h3>ğŸš¨ Alertas Activas ({{ alerts.length }})</h3>
            <div class="alerts-list">
              @for (alert of alerts; track alert.id) {
                <div class="alert-item"
                  [ngClass]="getAlertSeverityClass(alert.severity)">
                  
                  <div class="alert-content">
                    <div class="alert-message">{{ alert.message }}</div>
                    <div class="alert-meta">
                      <span class="alert-source">{{ alert.source }}</span>
                      <span class="alert-time">{{ alert.timestamp | date:'HH:mm' }}</span>
                    </div>
                  </div>

                  @if (!alert.acknowledged) {
                    <button
                      type="button"
                      (click)="dashboardService.acknowledgeAlert(alert.id)"
                      class="acknowledge-btn"
                      [attr.aria-label]="'Reconocer alerta: ' + alert.message">
                      âœ…
                    </button>
                  }

                </div>
              } @empty {
                <div class="no-alerts">
                  âœ… No hay alertas activas
                </div>
              }
            </div>
          </section>
        }

        <!-- ğŸ“Š ESTADÃSTICAS DEL DASHBOARD -->
        <section class="config-section">
          <h3>ğŸ“Š EstadÃ­sticas</h3>
          <div class="dashboard-stats">
            <div class="stat-item">
              <span class="stat-label">Widgets activos:</span>
              <span class="stat-value">{{ (widgets$ | async)?.length || 0 }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Ãšltima actualizaciÃ³n:</span>
              <span class="stat-value">{{ new Date() | date:'HH:mm:ss' }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Tema actual:</span>
              <span class="stat-value">{{ currentTheme }}</span>
            </div>
          </div>
        </section>

      </div>

    </aside>

    <!-- ğŸŒ«ï¸ OVERLAY -->
    <div class="config-overlay"
      (click)="closeConfigPanel()"
      [attr.aria-hidden]="true">
    </div>
  }

</div>