<div class="kanban-container">
  
  <!-- Dashboard de estadísticas -->
  <div class="dashboard-stats">
    <div class="stats-card">
      <div class="stat-icon">📊</div>
      <div class="stat-info">
        <h3>Total Proyectos</h3>
        <p class="stat-number">{{ stats().total }}</p>
      </div>
    </div>

    <div class="stats-card">
      <div class="stat-icon">📋</div>
      <div class="stat-info">
        <h3>Por Hacer</h3>
        <p class="stat-number">{{ stats().todo }}</p>
      </div>
    </div>

    <div class="stats-card">
      <div class="stat-icon">⚡</div>
      <div class="stat-info">
        <h3>En Progreso</h3>
        <p class="stat-number">{{ stats().progress }}</p>
      </div>
    </div>

    <div class="stats-card">
      <div class="stat-icon">✅</div>
      <div class="stat-info">
        <h3>Completado</h3>
        <p class="stat-number">{{ stats().done }}</p>
      </div>
    </div>

    <div class="stats-card">
      <div class="stat-icon">🔴</div>
      <div class="stat-info">
        <h3>Alta Prioridad</h3>
        <p class="stat-number">{{ stats().highPriority }}</p>
      </div>
    </div>

    <div class="stats-card completion-card">
      <div class="stat-icon">🎯</div>
      <div class="stat-info">
        <h3>Progreso Total</h3>
        <div class="progress-bar">
          <div 
            class="progress-fill" 
            [style.width.%]="stats().completionRate">
          </div>
        </div>
        <p class="stat-number">{{ stats().completionRate }}%</p>
      </div>
    </div>
  </div>

  <!-- Kanban Board principal con las 3 columnas especificadas -->
  <div class="kanban-board">
    
    @for (column of columns; track column.id) {
      <div 
        class="kanban-column" 
        [class.near-limit]="columnStatus()[column.id].isNearLimit"
        [class.at-limit]="columnStatus()[column.id].isAtLimit">
        
        <!-- Header de columna -->
        <div class="column-header">
          <div class="column-title">
            <span class="column-icon">{{ column.icon }}</span>
            <h3>{{ column.title }}</h3>
            <span class="task-count" 
                  [style.background]="column.color">
              {{ getTasksForColumn(column.id).length }}
              @if (column.maxTasks) {
                <span class="max-tasks">/ {{ column.maxTasks }}</span>
              }
            </span>
          </div>
          <p class="column-description">{{ column.description }}</p>
        </div>

        <!-- Zona de drop para la columna -->
        <div 
          class="task-drop-zone"
          [appDropZone]="column.id"
          (itemDropped)="onTaskDropped($event)">

          <!-- Lista de tareas en la columna -->
          <div class="tasks-list">
            @for (task of getTasksForColumn(column.id); track task.id) {
              <div 
                class="task-card"
                [class.recent-task]="isTaskRecent(task)"
                [class.updated-recently]="isTaskUpdatedRecently(task)"
                [appDraggable]="task"
                (dragStart)="onTaskDragStart(task)"
                (dragEnd)="onTaskDragEnd()">
                
                <!-- Header de tarjeta -->
                <div class="task-header">
                  <div class="task-priority" [class]="getPriorityClass(task.priority)">
                    <span class="priority-icon">{{ getPriorityIcon(task.priority) }}</span>
                    <span class="priority-label">{{ getPriorityLabel(task.priority) }}</span>
                  </div>
                  
                  <div class="task-id">#{{ task.id }}</div>
                </div>

                <!-- Contenido de tarjeta -->
                <div class="task-content">
                  <h4 class="task-title">{{ task.title }}</h4>
                  <p class="task-description">{{ task.description }}</p>
                </div>

                <!-- Metadata de tarjeta -->
                <div class="task-metadata">
                  @if (task.assignee) {
                    <div class="assignee">
                      <span class="assignee-icon">👤</span>
                      <span class="assignee-name">{{ task.assignee }}</span>
                    </div>
                  }
                  
                  <div class="task-dates">
                    <div class="date-info">
                      <span class="date-label">Creado:</span>
                      <span class="date-value">{{ formatDate(task.createdAt) }}</span>
                    </div>
                    
                    @if (task.updatedAt > task.createdAt) {
                      <div class="date-info updated">
                        <span class="date-label">Actualizado:</span>
                        <span class="date-value">{{ formatDate(task.updatedAt) }}</span>
                        <span class="days-ago">({{ getDaysAgo(task.updatedAt) }} días)</span>
                      </div>
                    }
                  </div>
                </div>

                <!-- Indicadores de estado -->
                <div class="task-indicators">
                  @if (isTaskRecent(task)) {
                    <span class="indicator new-task">🆕 Nuevo</span>
                  }
                  
                  @if (isTaskUpdatedRecently(task)) {
                    <span class="indicator updated-task">🔄 Actualizado</span>
                  }
                  
                  @if (task.priority === 'high') {
                    <span class="indicator critical-task">🚨 Crítico</span>
                  }
                </div>
              </div>
            }

            <!-- Mensaje cuando la columna está vacía -->
            @if (getTasksForColumn(column.id).length === 0) {
              <div class="empty-column">
                <div class="empty-icon">{{ column.icon }}</div>
                <p class="empty-message">
                  @if (column.id === 'todo') {
                    No hay proyectos por asignar
                  } @else if (column.id === 'progress') {
                    No hay proyectos en ejecución
                  } @else {
                    No hay proyectos completados
                  }
                </p>
                <p class="empty-hint">
                  Arrastra tareas aquí para cambiar su estado
                </p>
              </div>
            }

            <!-- Indicador de límite de columna -->
            @if (column.maxTasks && columnStatus()[column.id].isNearLimit) {
              <div class="column-warning">
                @if (columnStatus()[column.id].isAtLimit) {
                  <span class="warning-icon">🚫</span>
                  <span class="warning-text">Columna llena ({{ column.maxTasks }} max)</span>
                } @else {
                  <span class="warning-icon">⚠️</span>
                  <span class="warning-text">Cerca del límite ({{ column.maxTasks }} max)</span>
                }
              </div>
            }
          </div>
        </div>
      </div>
    }
  </div>

  <!-- Panel de información adicional -->
  <div class="info-panel">
    <div class="info-card">
      <h4>🎯 Instrucciones de Uso</h4>
      <ul>
        <li>📋 <strong>Arrastra tarjetas</strong> entre las columnas para cambiar el estado</li>
        <li>🔄 Los cambios se guardan automáticamente en localStorage</li>
        <li>📊 Las estadísticas se actualizan en tiempo real</li>
        <li>⚠️ Algunas columnas tienen límites máximos de tareas</li>
      </ul>
    </div>

    <div class="info-card">
      <h4>📈 Leyenda de Prioridades</h4>
      <div class="priority-legend">
        <div class="priority-item">
          <span class="priority-icon">🟢</span>
          <span>Baja - Mantenimiento rutinario</span>
        </div>
        <div class="priority-item">
          <span class="priority-icon">🟡</span>
          <span>Media - Proyectos planificados</span>
        </div>
        <div class="priority-item">
          <span class="priority-icon">🔴</span>
          <span>Crítica - Infraestructura esencial</span>
        </div>
      </div>
    </div>

    <div class="info-card technical-info">
      <h4>⚙️ Implementación Técnica</h4>
      <div class="tech-details">
        <div class="tech-item">
          <strong>🖱️ DraggableDirective:</strong> HostBinding + HostListener
        </div>
        <div class="tech-item">
          <strong>🎯 DropZoneDirective:</strong> Renderer2 + HTML5 Drag API
        </div>
        <div class="tech-item">
          <strong>📊 Signals:</strong> Estado reactivo con computed()
        </div>
        <div class="tech-item">
          <strong>💾 localStorage:</strong> Persistencia automática
        </div>
      </div>
    </div>

    <!-- Botón de reset para testing -->
    <div class="info-card">
      <h4>🔧 Herramientas de Testing</h4>
      <button 
        class="reset-btn" 
        (click)="resetToDefaults()"
        title="Borra los datos guardados y recarga la página">
        🔄 Resetear Datos
      </button>
    </div>
  </div>
</div>
