<!-- üéØ COMPONENTE LISTA DE PRODUCTOS - LAB 1
     üì¶ Interface profesional para gesti√≥n CRUD de productos
     üé® Dise√±o moderno con mejores pr√°cticas UX/UI -->

<div class="product-list-container">
  
  <!-- ========================================
       HEADER PRINCIPAL
       ======================================== -->
  <section class="page-header">
    <div class="header-content">
      <div class="header-text">
        <h1>üõí Gesti√≥n de Productos</h1>
        <p>Sistema integral para administraci√≥n de inventarios - PROVIAS Descentralizado</p>
      </div>
      <div class="header-actions">
        <button 
          class="btn btn-primary btn-lg"
          (click)="showCreateProductForm()"
          [disabled]="loading()">
          <span>‚ú®</span>
          Nuevo Producto
        </button>
        <button 
          class="btn btn-secondary"
          (click)="loadProducts()"
          [disabled]="loading()">
          @if (loading()) {
            <span class="loading-spinner"></span>
          } @else {
            <span>üîÑ</span>
          }
          Actualizar
        </button>
      </div>
    </div>
  </section>

  <!-- ========================================
       ALERTAS Y ERRORES
       ======================================== -->
  @if (error()) {
    <div class="alert alert-error fade-in">
      <span>‚ö†Ô∏è</span>
      <span>{{ error() }}</span>
      <button (click)="clearError()" class="btn btn-sm btn-secondary">
        <span>‚úï</span>
      </button>
    </div>
  }

  <!-- ========================================
       ESTAD√çSTICAS
       ======================================== -->
  @if (statistics(); as stats) {
    <section class="stats-grid fade-in">
      <div class="stat-card">
        <div class="stat-icon stat-total">üì¶</div>
        <div class="stat-label">Total Productos</div>
        <div class="stat-number">{{ stats.total }}</div>
        <div class="stat-change">Inventario completo</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon stat-categories">üìÇ</div>
        <div class="stat-label">Categor√≠as Activas</div>
        <div class="stat-number">{{ stats.categories }}</div>
        <div class="stat-change">{{ stats.categories }} diferentes</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon stat-stock">‚ö†Ô∏è</div>
        <div class="stat-label">Stock Bajo</div>
        <div class="stat-number">{{ stats.lowStock }}</div>
        <div class="stat-change">{{ stats.lowStock > 0 ? 'Requiere atenci√≥n' : 'Todo en orden' }}</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon stat-value">üí∞</div>
        <div class="stat-label">Valor Total Inventario</div>
        <div class="stat-number">S/ {{ stats.totalValue | number:'1.2-2' }}</div>
        <div class="stat-change">Valorizaci√≥n actual</div>
      </div>
    </section>
  }

  <!-- ========================================
       FILTROS Y B√öSQUEDA
       ======================================== -->
  <section class="filters-section fade-in">
    <div class="filters-header">
      <h3>üîç Filtros y B√∫squeda</h3>
      <button 
        class="clear-filters"
        (click)="clearFilters()"
        [disabled]="!hasActiveFilters()">
        Limpiar Filtros
      </button>
    </div>
    
    <div class="filters-grid">
      <!-- B√∫squeda por texto -->
      <div class="form-group">
        <label>Buscar productos</label>
        <div class="search-box">
          <input 
            type="text"
            [(ngModel)]="searchTerm"
            (input)="onSearchChange()"
            placeholder="Buscar por nombre o descripci√≥n..."
            class="search-input">
          <span class="search-icon">üîç</span>
        </div>
      </div>

      <!-- Filtro por categor√≠a -->
      <div class="form-group">
        <label>Categor√≠a</label>
        <select 
          [(ngModel)]="selectedCategory"
          (change)="onFilterChange()">
          <option value="">Todas las categor√≠as</option>
          @for (category of availableCategories(); track category) {
            <option [value]="category">{{ category }}</option>
          }
        </select>
      </div>

      <!-- Filtro por precio m√≠nimo -->
      <div class="form-group">
        <label>Precio m√≠nimo</label>
        <input 
          type="number"
          [(ngModel)]="minPrice"
          (input)="onFilterChange()"
          placeholder="0.00"
          min="0"
          step="0.01">
      </div>

      <!-- Filtro por precio m√°ximo -->
      <div class="form-group">
        <label>Precio m√°ximo</label>
        <input 
          type="number"
          [(ngModel)]="maxPrice"
          (input)="onFilterChange()"
          placeholder="0.00"
          min="0"
          step="0.01">
      </div>

      <!-- Filtro por stock -->
      <div class="form-group">
        <label>Estado de stock</label>
        <select 
          [(ngModel)]="stockFilter"
          (change)="onFilterChange()">
          <option value="">Todos los productos</option>
          <option value="inStock">Solo con stock</option>
          <option value="lowStock">Stock bajo (‚â§5)</option>
          <option value="outOfStock">Sin stock</option>
        </select>
      </div>

      <!-- Ordenamiento -->
      <div class="form-group">
        <label>Ordenar por</label>
        <select 
          [(ngModel)]="sortBy"
          (change)="onFilterChange()">
          <option value="name">Nombre</option>
          <option value="price">Precio</option>
          <option value="stock">Stock</option>
          <option value="createdAt">Fecha creaci√≥n</option>
        </select>
      </div>
    </div>
  </section>

  <!-- ========================================
       LISTA DE PRODUCTOS
       ======================================== -->
  <section class="products-section">
    <div class="section-header">
      <div class="results-count">
        @if (filteredProducts().length > 0) {
          <span>Mostrando {{ filteredProducts().length }} de {{ products().length }} productos</span>
        } @else if (products().length > 0) {
          <span>No se encontraron productos con los filtros aplicados</span>
        } @else {
          <span>No hay productos registrados</span>
        }
      </div>
      
      <div class="view-options">
        <button 
          class="active"
          title="Vista de tarjetas">
          üì±
        </button>
        <button 
          title="Vista de lista">
          üìã
        </button>
      </div>
    </div>

    <!-- Loading State -->
    @if (loading()) {
      <div class="loading-grid">
        @for (item of [1,2,3,4,5,6]; track item) {
          <div class="loading-card">
            <div class="loading-image"></div>
            <div class="loading-content">
              <div class="loading-line short"></div>
              <div class="loading-line medium"></div>
              <div class="loading-line long"></div>
              <div class="loading-line short"></div>
            </div>
          </div>
        }
      </div>
    }

    <!-- Error State -->
    @else if (error()) {
      <div class="error-state">
        <div class="state-icon">üòµ</div>
        <h2 class="state-title">Error al cargar productos</h2>
        <p class="state-description">
          Ocurri√≥ un problema al conectar con el servidor. 
          Verifica tu conexi√≥n y vuelve a intentarlo.
        </p>
        <button class="btn btn-primary" (click)="loadProducts()">
          <span>üîÑ</span>
          Reintentar
        </button>
      </div>
    }

    <!-- Empty State -->
    @else if (filteredProducts().length === 0 && products().length === 0) {
      <div class="empty-state">
        <div class="state-icon">üì¶</div>
        <h2 class="state-title">No hay productos registrados</h2>
        <p class="state-description">
          Comienza agregando tu primer producto al inventario. 
          Es f√°cil y r√°pido con nuestro formulario intuitivo.
        </p>
        <button class="btn btn-primary btn-lg" (click)="showCreateProductForm()">
          <span>‚ú®</span>
          Crear Primer Producto
        </button>
      </div>
    }

    <!-- No Results State -->
    @else if (filteredProducts().length === 0) {
      <div class="empty-state">
        <div class="state-icon">üîç</div>
        <h2 class="state-title">No se encontraron resultados</h2>
        <p class="state-description">
          Intenta ajustar tus filtros de b√∫squeda o t√©rminos 
          para encontrar los productos que buscas.
        </p>
        <button class="btn btn-secondary" (click)="clearFilters()">
          <span>üóëÔ∏è</span>
          Limpiar Filtros
        </button>
      </div>
    }

    <!-- Products Grid -->
    @else {
      <div class="products-grid fade-in">
        @for (product of filteredProducts(); track product.id) {
          <div class="product-card slide-up">
            <!-- Imagen del producto -->
            <div class="product-image">
              <span>üì¶</span>
              <div class="stock-badge" 
                   [class]="getStockClass(product.stock)">
                @if (product.stock > 10) {
                  <span>En Stock</span>
                } @else if (product.stock > 0) {
                  <span>Stock Bajo</span>
                } @else {
                  <span>Agotado</span>
                }
              </div>
            </div>

            <!-- Contenido de la tarjeta -->
            <div class="product-content">
              <div class="product-category">{{ product.category }}</div>
              <h3 class="product-name">{{ product.name }}</h3>
              <p class="product-description">{{ product.description }}</p>
              
              <div class="product-details">
                <div class="product-price">
                  S/ {{ product.price | number:'1.2-2' }}
                </div>
                <div class="product-stock">
                  Stock: <span class="stock-number">{{ product.stock }}</span>
                </div>
              </div>

              <div class="product-actions">
                <button 
                  class="btn btn-secondary btn-sm"
                  (click)="selectProduct(product)"
                  title="Ver detalles">
                  <span>üëÅÔ∏è</span>
                  Ver
                </button>
                <button 
                  class="btn btn-primary btn-sm"
                  (click)="editProduct(product)"
                  title="Editar producto">
                  <span>‚úèÔ∏è</span>
                  Editar
                </button>
                <button 
                  class="btn btn-error btn-sm"
                  (click)="showDeleteConfirmation(product)"
                  title="Eliminar producto">
                  <span>üóëÔ∏è</span>
                  Eliminar
                </button>
              </div>
            </div>
          </div>
        }
      </div>
    }
  </section>

  <!-- ========================================
       MODAL DE FORMULARIO
       ======================================== -->
  @if (showForm()) {
    <div class="modal-overlay" (click)="closeModalOnOverlay($event)">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>
            @if (editingProduct()) {
              <span>‚úèÔ∏è Editar Producto</span>
            } @else {
              <span>‚ú® Nuevo Producto</span>
            }
          </h2>
          <button class="close-button" (click)="hideForm()">‚úï</button>
        </div>

        <form (ngSubmit)="saveProduct()" #productForm="ngForm" class="modal-body">
          <div class="form-grid">
            <div class="form-group">
              <label for="productName">Nombre del Producto *</label>
              <input 
                type="text"
                id="productName"
                name="name"
                [(ngModel)]="formProduct().name"
                #nameField="ngModel"
                required
                minlength="3"
                maxlength="100"
                placeholder="Ej: Laptop Dell Inspiron 15">
              @if (nameField.invalid && nameField.touched) {
                <div class="field-error">
                  @if (nameField.errors?.['required']) {
                    El nombre es requerido
                  }
                  @if (nameField.errors?.['minlength']) {
                    M√≠nimo 3 caracteres
                  }
                </div>
              }
            </div>

            <div class="form-group">
              <label for="productCategory">Categor√≠a *</label>
              <select 
                id="productCategory"
                name="category"
                [(ngModel)]="formProduct().category"
                #categoryField="ngModel"
                required>
                <option value="">Seleccionar categor√≠a</option>
                <option value="electronics">Electr√≥nicos</option>
                <option value="laptops">Laptops</option>
                <option value="smartphones">Smartphones</option>
                <option value="tablets">Tablets</option>
                <option value="accessories">Accesorios</option>
                <option value="software">Software</option>
                <option value="books">Libros</option>
                <option value="office">Oficina</option>
              </select>
              @if (categoryField.invalid && categoryField.touched) {
                <div class="field-error">La categor√≠a es requerida</div>
              }
            </div>

            <div class="form-group">
              <label for="productPrice">Precio (S/) *</label>
              <input 
                type="number"
                id="productPrice"
                name="price"
                [(ngModel)]="formProduct().price"
                #priceField="ngModel"
                required
                min="0.01"
                step="0.01"
                placeholder="0.00">
              @if (priceField.invalid && priceField.touched) {
                <div class="field-error">
                  @if (priceField.errors?.['required']) {
                    El precio es requerido
                  }
                  @if (priceField.errors?.['min']) {
                    El precio debe ser mayor a 0
                  }
                </div>
              }
            </div>

            <div class="form-group">
              <label for="productStock">Stock Inicial *</label>
              <input 
                type="number"
                id="productStock"
                name="stock"
                [(ngModel)]="formProduct().stock"
                #stockField="ngModel"
                required
                min="0"
                placeholder="0">
              @if (stockField.invalid && stockField.touched) {
                <div class="field-error">
                  @if (stockField.errors?.['required']) {
                    El stock es requerido
                  }
                  @if (stockField.errors?.['min']) {
                    El stock no puede ser negativo
                  }
                </div>
              }
            </div>
          </div>

          <div class="form-group">
            <label for="productDescription">Descripci√≥n *</label>
            <textarea 
              id="productDescription"
              name="description"
              [(ngModel)]="formProduct().description"
              #descriptionField="ngModel"
              required
              minlength="10"
              maxlength="500"
              rows="4"
              placeholder="Describe las caracter√≠sticas principales del producto..."></textarea>
            @if (descriptionField.invalid && descriptionField.touched) {
              <div class="field-error">
                @if (descriptionField.errors?.['required']) {
                  La descripci√≥n es requerida
                }
                @if (descriptionField.errors?.['minlength']) {
                  M√≠nimo 10 caracteres
                }
              </div>
            }
            <div class="field-help">
              {{ formProduct().description.length || 0 }}/500 caracteres
            </div>
          </div>
        </form>

        <div class="modal-footer">
          <button 
            type="button"
            class="btn btn-secondary"
            (click)="hideForm()">
            <span>‚úï</span>
            Cancelar
          </button>
          <button 
            type="submit"
            class="btn btn-primary"
            (click)="saveProduct()"
            [disabled]="!productForm.form.valid || loading()">
            @if (loading()) {
              <span class="loading-spinner"></span>
            } @else if (editingProduct()) {
              <span>üíæ</span>
            } @else {
              <span>‚ú®</span>
            }
            {{ editingProduct() ? 'Actualizar' : 'Crear' }} Producto
          </button>
        </div>
      </div>
    </div>
  }

  <!-- ========================================
       MODAL DE CONFIRMACI√ìN DE ELIMINACI√ìN
       ======================================== -->
  @if (showDeleteModal()) {
    <div class="modal-overlay" (click)="closeDeleteModal()">
      <div class="modal-content delete-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>üóëÔ∏è Confirmar Eliminaci√≥n</h2>
          <button class="close-button" (click)="closeDeleteModal()">‚úï</button>
        </div>

        <div class="modal-body">
          <div class="delete-warning">
            <div class="warning-icon">‚ö†Ô∏è</div>
            <div class="warning-content">
              <h3>¬øEst√°s seguro de que quieres eliminar este producto?</h3>
              @if (productToDelete()) {
                <p><strong>{{ productToDelete()!.name }}</strong></p>
                <p class="warning-text">
                  Esta acci√≥n no se puede deshacer. El producto ser√° eliminado permanentemente
                  del inventario junto con toda su informaci√≥n.
                </p>
              }
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button 
            type="button"
            class="btn btn-secondary"
            (click)="closeDeleteModal()">
            <span>‚úï</span>
            Cancelar
          </button>
          <button 
            type="button"
            class="btn btn-error"
            (click)="confirmDeleteProduct()"
            [disabled]="loading()">
            @if (loading()) {
              <span class="loading-spinner"></span>
            } @else {
              <span>üóëÔ∏è</span>
            }
            Eliminar Producto
          </button>
        </div>
      </div>
    </div>
  }

  <!-- ========================================
       LOADING GLOBAL
       ======================================== -->
  @if (loading() && showGlobalLoading()) {
    <div class="loading-overlay">
      <div class="loading-content">
        <div class="loading-spinner"></div>
        <p>Procesando solicitud...</p>
      </div>
    </div>
  }

</div>

<!-- Estilos adicionales espec√≠ficos del componente -->
<style>
.field-error {
  color: var(--error-color);
  font-size: var(--font-size-xs);
  margin-top: var(--spacing-1);
  font-weight: 500;
}

.field-help {
  color: var(--secondary-color);
  font-size: var(--font-size-xs);
  margin-top: var(--spacing-1);
  text-align: right;
}

/* Modal de confirmaci√≥n de eliminaci√≥n */
.delete-modal {
  max-width: 500px;
}

.delete-warning {
  display: flex;
  gap: var(--spacing-4);
  padding: var(--spacing-4);
  background-color: var(--error-light);
  border-radius: var(--border-radius-base);
  border: 1px solid #fecaca;
}

.warning-icon {
  font-size: 48px;
  flex-shrink: 0;
}

.warning-content h3 {
  color: var(--error-color);
  font-size: var(--font-size-lg);
  margin-bottom: var(--spacing-3);
  font-weight: 600;
}

.warning-content p {
  margin: var(--spacing-2) 0;
  color: #7f1d1d;
}

.warning-content strong {
  color: var(--error-color);
  font-weight: 600;
}

.warning-text {
  font-size: var(--font-size-sm);
  line-height: 1.5;
  color: #991b1b !important;
}

.delete-modal .modal-footer {
  background-color: #fef2f2;
  border-top-color: #fecaca;
}

.delete-modal .btn-error:not(:disabled):hover {
  background-color: #b91c1c;
  transform: translateY(-1px);
}
</style>