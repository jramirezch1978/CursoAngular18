<div class="lab4-container">
  <header class="lab-header">
    <h1>🔄 LAB 4: MIGRACIÓN Y ESTADO GLOBAL</h1>
    <p class="subtitle">PROVIAS DESCENTRALIZADO - Angular v18</p>
    <p class="instructor">Instructor: Ing. Jhonny Alexander Ramirez Chiroque</p>
    <div class="integration-badge">🎯 Integración Pura 🎯</div>
  </header>

  <nav class="navigation-tabs">
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'intro'"
      (click)="setActiveTab('intro')">
      🎯 Migración Estratégica
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'comparison'"
      (click)="setActiveTab('comparison')">
      ⚖️ Antes vs Después
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'global-state'"
      (click)="setActiveTab('global-state')">
      🌍 Estado Global
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'hybrid'"
      (click)="setActiveTab('hybrid')">
      🌉 Arquitectura Híbrida
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'provias-demo'"
      (click)="setActiveTab('provias-demo')">
      🏛️ Demo PROVIAS
    </button>
  </nav>

  <main class="lab-content">
    <!-- Introducción Migración -->
    <section *ngIf="activeTab === 'intro'" class="content-section">
      <div class="theory-box">
        <h2>🎯 Migración Estratégica - No Todo Debe Cambiar</h2>
        <blockquote>
          "La migración no es solo un ejercicio académico. Muchas aplicaciones Angular existentes están haciendo esta transición. Serán los expertos que sus empresas necesitan para modernizar código legacy."
          <footer>- Ing. Jhonny Ramirez</footer>
        </blockquote>
        
        <div class="migration-rules">
          <h3>🎯 Reglas de Oro para Migración</h3>
          <div class="rules-grid">
            <div class="rule-card migrate">
              <h4>✅ MIGRAR a Signals</h4>
              <ul>
                <li>🏠 Estado local de componente</li>
                <li>🔢 Datos síncronos simples</li>
                <li>📊 Derivaciones automáticas</li>
                <li>🎨 UI reactiva simple</li>
                <li>🧮 Contadores, flags, objetos</li>
              </ul>
            </div>
            
            <div class="rule-card keep-rxjs">
              <h4>❌ NO MIGRAR (mantener RxJS)</h4>
              <ul>
                <li>🌐 HTTP requests complejos</li>
                <li>⚡ Operaciones con operadores</li>
                <li>⏰ Streams temporales</li>
                <li>🔍 Búsquedas con debounce complejo</li>
                <li>💎 Si ya funciona perfectamente</li>
              </ul>
            </div>
          </div>
        </div>

        <div class="migration-strategy">
          <h3>📋 Estrategia de Migración</h3>
          <div class="strategy-steps">
            <div class="step-card">
              <span class="step-number">1</span>
              <h4>Identificar Candidatos</h4>
              <p>Analizar qué servicios y componentes son buenos candidatos</p>
            </div>
            <div class="step-card">
              <span class="step-number">2</span>
              <h4>Migración Gradual</h4>
              <p>Feature por feature, service por service. Mantener interoperabilidad</p>
            </div>
            <div class="step-card">
              <span class="step-number">3</span>
              <h4>Testing y Validación</h4>
              <p>Comparar comportamiento y performance antes/después</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Comparación Antes vs Después -->
    <section *ngIf="activeTab === 'comparison'" class="content-section">
      <div class="theory-box">
        <h2>⚖️ Cart Service: Antes vs Después</h2>
        <blockquote>
          "El NewCartService con Signals es refrescantemente simple. El mismo funcionalidad, la mitad del código, más fácil de entender."
          <footer>- Ing. Jhonny Ramirez</footer>
        </blockquote>
      </div>

      <div class="comparison-demo">
        <div class="cart-comparison">
          <div class="old-way">
            <h3>🏚️ ANTES: RxJS BehaviorSubject</h3>
            <div class="code-example">
              <pre><code>// RxJS Pattern - Ceremonioso
private cartItemsSubject = new BehaviorSubject&lt;Item[]&gt;([]);
public cartItems$ = this.cartItemsSubject.asObservable();

public totalItems$ = this.cartItems$.pipe(
  map(items => items.reduce((sum, item) => sum + item.quantity, 0))
);

// En template necesitas async pipe
&lt;div&gt;{{ totalItems$ | async }}&lt;/div&gt;</code></pre>
            </div>
            
            <div class="old-cart-demo">
              <h4>🛒 Demo Cart Antiguo (RxJS)</h4>
              <div class="cart-actions">
                <button class="add-btn old" (click)="addToOldCart()">
                  ➕ Agregar Item (RxJS)
                </button>
                <button class="clear-btn old" (click)="clearOldCart()">
                  🧹 Limpiar (RxJS)
                </button>
              </div>
              
              <div class="cart-info">
                <div class="info-item">
                  <span>Items:</span>
                  <span>{{ oldCartItems$ | async | json }}</span>
                </div>
                <div class="info-item">
                  <span>Total Items:</span>
                  <span>{{ oldTotalItems$ | async }}</span>
                </div>
              </div>
            </div>
          </div>

          <div class="new-way">
            <h3>✨ DESPUÉS: Angular Signals</h3>
            <div class="code-example">
              <pre><code>// Signals Pattern - Elegante
private cartItemsSignal = signal&lt;Item[]&gt;([]);
public cartItems = this.cartItemsSignal.asReadonly();

public totalItems = computed(() => 
  this.cartItemsSignal().reduce((sum, item) => sum + item.quantity, 0)
);

// En template es directo
&lt;div&gt;{{ totalItems() }}&lt;/div&gt;</code></pre>
            </div>
            
            <div class="new-cart-demo">
              <h4>🛒 Demo Cart Nuevo (Signals)</h4>
              <div class="cart-actions">
                <button class="add-btn new" (click)="addToNewCart()">
                  ➕ Agregar Item (Signals)
                </button>
                <button class="clear-btn new" (click)="clearNewCart()">
                  🧹 Limpiar (Signals)
                </button>
              </div>
              
              <div class="cart-info">
                <div class="info-item">
                  <span>Items:</span>
                  <span>{{ newCartItems() | json }}</span>
                </div>
                <div class="info-item">
                  <span>Total Items:</span>
                  <span>{{ newTotalItems() }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="metrics-comparison">
          <h3>📊 Comparación de Métricas</h3>
          <table class="metrics-table">
            <thead>
              <tr>
                <th>Aspecto</th>
                <th>RxJS BehaviorSubject</th>
                <th>Signals</th>
                <th>Ventaja</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>Líneas de Código</strong></td>
                <td class="old">~80 líneas</td>
                <td class="new">~60 líneas</td>
                <td class="advantage">25% menos código</td>
              </tr>
              <tr>
                <td><strong>Suscripciones</strong></td>
                <td class="old">Manual + async pipe</td>
                <td class="new">Automáticas</td>
                <td class="advantage">Sin gestión manual</td>
              </tr>
              <tr>
                <td><strong>Memory Leaks</strong></td>
                <td class="old">Posibles</td>
                <td class="new">Imposibles</td>
                <td class="advantage">Más seguro</td>
              </tr>
              <tr>
                <td><strong>Performance</strong></td>
                <td class="old">Bueno</td>
                <td class="new">Mejor</td>
                <td class="advantage">Síncrono directo</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Estado Global -->
    <section *ngIf="activeTab === 'global-state'" class="content-section">
      <div class="theory-box">
        <h2>🌍 Estado Global Profesional</h2>
        <blockquote>
          "GlobalStateService es su store centralizado, pero sin la ceremonia de NgRx o Akita. Es estado global con la simplicidad de Signals."
          <footer>- Ing. Jhonny Ramirez</footer>
        </blockquote>
      </div>

      <div class="global-state-demo">
        <div class="state-sections">
          <!-- Authentication State -->
          <div class="state-section auth">
            <h3>🔐 Estado de Autenticación</h3>
            <div class="auth-demo">
              <div class="user-info" *ngIf="globalState.currentUser(); else noUser">
                <div class="user-card">
                  <strong>{{ globalState.currentUser()?.name }}</strong>
                  <span>{{ globalState.currentUser()?.email }}</span>
                  <span class="role">{{ globalState.currentUser()?.role }}</span>
                </div>
                <button class="logout-btn" (click)="logout()">
                  🚪 Cerrar Sesión
                </button>
              </div>
              <ng-template #noUser>
                <div class="login-form">
                  <input type="text" [(ngModel)]="loginForm.username" placeholder="Usuario">
                  <input type="password" [(ngModel)]="loginForm.password" placeholder="Contraseña">
                  <button class="login-btn" (click)="login()">
                    🔑 Iniciar Sesión
                  </button>
                </div>
              </ng-template>
              
              <div class="auth-status">
                <div class="status-item">
                  <span>Autenticado:</span>
                  <span [class.yes]="globalState.isAuthenticated()" [class.no]="!globalState.isAuthenticated()">
                    {{ globalState.isAuthenticated() ? '✅ Sí' : '❌ No' }}
                  </span>
                </div>
                <div class="status-item">
                  <span>Rol:</span>
                  <span>{{ globalState.userRole() }}</span>
                </div>
                <div class="status-item">
                  <span>Acceso Admin:</span>
                  <span [class.yes]="globalState.canAccessAdmin()" [class.no]="!globalState.canAccessAdmin()">
                    {{ globalState.canAccessAdmin() ? '✅ Sí' : '❌ No' }}
                  </span>
                </div>
              </div>
            </div>
          </div>

          <!-- UI State -->
          <div class="state-section ui">
            <h3>🎨 Estado de Interfaz</h3>
            <div class="ui-controls">
              <div class="control-group">
                <label>Tema:</label>
                <button 
                  class="theme-btn"
                  [class.dark]="globalState.isDarkMode()"
                  (click)="globalState.toggleTheme()">
                  {{ globalState.theme() === 'light' ? '☀️ Claro' : '🌙 Oscuro' }}
                </button>
              </div>
              
              <div class="control-group">
                <label>Idioma:</label>
                <select [value]="globalState.language()" (change)="changeLanguage($event)">
                  <option value="es">🇪🇸 Español</option>
                  <option value="en">🇺🇸 English</option>
                </select>
              </div>
              
              <div class="control-group">
                <label>Sidebar:</label>
                <button 
                  class="sidebar-btn"
                  [class.open]="globalState.sidebarOpen()"
                  (click)="globalState.toggleSidebar()">
                  {{ globalState.sidebarOpen() ? '📱 Abierto' : '📱 Cerrado' }}
                </button>
              </div>
            </div>
          </div>

          <!-- Notifications State -->
          <div class="state-section notifications">
            <h3>🔔 Sistema de Notificaciones</h3>
            <div class="notifications-demo">
              <div class="notification-controls">
                <button class="notify-btn info" (click)="addInfoNotification()">
                  ℹ️ Info
                </button>
                <button class="notify-btn success" (click)="addSuccessNotification()">
                  ✅ Éxito
                </button>
                <button class="notify-btn warning" (click)="addWarningNotification()">
                  ⚠️ Advertencia
                </button>
                <button class="notify-btn error" (click)="addErrorNotification()">
                  ❌ Error
                </button>
              </div>
              
              <div class="notifications-status">
                <div class="status-item">
                  <span>Total:</span>
                  <span class="badge">{{ globalState.notifications().length }}</span>
                </div>
                <div class="status-item">
                  <span>No leídas:</span>
                  <span class="badge unread">{{ globalState.unreadCount() }}</span>
                </div>
              </div>
              
              <div class="notifications-list" *ngIf="globalState.notifications().length > 0">
                @for (notification of globalState.notifications().slice(0, 5); track notification.id) {
                  <div class="notification-item" [class]="notification.type" [class.read]="notification.read">
                    <div class="notification-content">
                      <strong>{{ notification.title }}</strong>
                      <p>{{ notification.message }}</p>
                    </div>
                    <button 
                      class="mark-read-btn" 
                      *ngIf="!notification.read"
                      (click)="globalState.markNotificationAsRead(notification.id)">
                      ✓
                    </button>
                  </div>
                }
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Comparación Directa -->
    <section *ngIf="activeTab === 'comparison'" class="content-section">
      <div class="theory-box">
        <h2>⚖️ Comparación Directa: RxJS vs Signals</h2>
        <blockquote>
          "La comparación de totalItems es reveladora. Con RxJS, necesitan pipe y map. Con Signals, computed hace el trabajo. Ambos son reactivos, pero Signals es más directo."
          <footer>- Ing. Jhonny Ramirez</footer>
        </blockquote>
      </div>

      <div class="side-by-side-demo">
        <div class="demo-section">
          <h3>🏚️ Implementación RxJS Legacy</h3>
          <div class="legacy-demo">
            <div class="cart-display old">
              <h4>🛒 Carrito RxJS</h4>
              <div class="cart-items">
                @for (item of (oldCartItems$ | async) || []; track item.id) {
                  <div class="cart-item">
                    {{ item.name }} - ${{ item.price }} x {{ item.quantity }}
                  </div>
                }
              </div>
              <div class="cart-totals">
                <div class="total-line">
                  <span>Total Items:</span>
                  <span class="total-value">{{ oldTotalItems$ | async }}</span>
                </div>
                <div class="total-line">
                  <span>Total Precio:</span>
                  <span class="total-value">${{ oldTotalPrice$ | async }}</span>
                </div>
                <div class="total-line">
                  <span>Está Vacío:</span>
                  <span class="total-value">{{ (oldIsEmpty$ | async) ? 'Sí' : 'No' }}</span>
                </div>
              </div>
            </div>
            
            <div class="old-actions">
              <button class="add-item-btn old" (click)="addToOldCart()">
                ➕ Agregar Item
              </button>
              <button class="remove-item-btn old" (click)="removeFromOldCart()">
                ➖ Remover Item
              </button>
            </div>
          </div>
        </div>

        <div class="demo-section">
          <h3>✨ Implementación Signals Moderna</h3>
          <div class="modern-demo">
            <div class="cart-display new">
              <h4>🛒 Carrito Signals</h4>
              <div class="cart-items">
                @for (item of newCartItems(); track item.id) {
                  <div class="cart-item">
                    {{ item.name }} - ${{ item.price }} x {{ item.quantity }}
                  </div>
                }
              </div>
              <div class="cart-totals">
                <div class="total-line">
                  <span>Total Items:</span>
                  <span class="total-value">{{ newTotalItems() }}</span>
                </div>
                <div class="total-line">
                  <span>Total Precio:</span>
                  <span class="total-value">${{ newTotalPrice() }}</span>
                </div>
                <div class="total-line">
                  <span>Está Vacío:</span>
                  <span class="total-value">{{ newIsEmpty() ? 'Sí' : 'No' }}</span>
                </div>
              </div>
            </div>
            
            <div class="new-actions">
              <button class="add-item-btn new" (click)="addToNewCart()">
                ➕ Agregar Item
              </button>
              <button class="remove-item-btn new" (click)="removeFromNewCart()">
                ➖ Remover Item
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Estado Global Demo -->
    <section *ngIf="activeTab === 'global-state'" class="content-section">
      <div class="theory-box">
        <h2>🌍 Estado Global sin Ceremonia</h2>
        <blockquote>
          "Este patrón escala perfectamente. Pueden tener múltiples servicios de estado para diferentes dominios. UserState, CartState, UIState."
          <footer>- Ing. Jhonny Ramirez</footer>
        </blockquote>
      </div>

      <div class="global-demo">
        <div class="global-dashboard">
          <h3>📊 Dashboard de Estado Global</h3>
          
          <div class="dashboard-grid">
            <div class="dashboard-card user">
              <h4>👤 Usuario Global</h4>
              <div class="card-content">
                <div class="status-indicator" [class.active]="globalState.isAuthenticated()">
                  {{ globalState.isAuthenticated() ? '🟢 Conectado' : '🔴 Desconectado' }}
                </div>
                <div *ngIf="globalState.currentUser()">
                  <strong>{{ globalState.currentUser()?.name }}</strong>
                  <span>{{ globalState.userRole() }}</span>
                </div>
              </div>
            </div>

            <div class="dashboard-card theme">
              <h4>🎨 Tema Global</h4>
              <div class="card-content">
                <div class="theme-display" [class]="globalState.theme()">
                  {{ globalState.theme() === 'light' ? '☀️ Modo Claro' : '🌙 Modo Oscuro' }}
                </div>
                <button class="theme-toggle" (click)="globalState.toggleTheme()">
                  Cambiar Tema
                </button>
              </div>
            </div>

            <div class="dashboard-card notifications">
              <h4>🔔 Notificaciones</h4>
              <div class="card-content">
                <div class="notification-summary">
                  <span class="total">{{ globalState.notifications().length }} total</span>
                  <span class="unread">{{ globalState.unreadCount() }} no leídas</span>
                </div>
                <button class="clear-notifications" (click)="globalState.clearAllNotifications()">
                  🧹 Limpiar Todo
                </button>
              </div>
            </div>

            <div class="dashboard-card projects">
              <h4>🏗️ Proyectos PROVIAS</h4>
              <div class="card-content">
                <div class="projects-summary">
                  <div class="project-stat">
                    <span class="stat-value">{{ globalState.projects().length }}</span>
                    <span class="stat-label">Total</span>
                  </div>
                  <div class="project-stat">
                    <span class="stat-value">{{ globalState.activeProjectsCount() }}</span>
                    <span class="stat-label">Activos</span>
                  </div>
                </div>
                <button class="load-projects-btn" (click)="globalState.loadProjects()">
                  📋 Cargar Proyectos
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Arquitectura Híbrida -->
    <section *ngIf="activeTab === 'hybrid'" class="content-section">
      <div class="theory-box">
        <h2>🌉 Arquitectura Híbrida - Lo Mejor de Ambos Mundos</h2>
        <blockquote>
          "El ejemplo de interoperabilidad muestra que no es una decisión binaria. En la misma aplicación, el mismo componente, pueden usar ambos."
          <footer>- Ing. Jhonny Ramirez</footer>
        </blockquote>
      </div>

      <div class="hybrid-demo">
        <div class="hybrid-examples">
          <div class="bridge-demo">
            <h3>🌉 Puentes de Interoperabilidad</h3>
            
            <div class="bridge-examples">
              <div class="bridge-card">
                <h4>Signal → Observable</h4>
                <code>userObservable$ = toObservable(userSignal)</code>
                <button class="test-bridge" (click)="testSignalToObservable()">
                  Probar Conversión
                </button>
              </div>
              
              <div class="bridge-card">
                <h4>Observable → Signal</h4>
                <code>dataSignal = toSignal(data$, { initialValue: [] })</code>
                <button class="test-bridge" (click)="testObservableToSignal()">
                  Probar Conversión
                </button>
              </div>
            </div>
          </div>

          <div class="real-time-demo">
            <h3>📡 Demo: HTTP + Signals + WebSocket</h3>
            <div class="realtime-status">
              <div class="connection-status">
                <span class="status-dot" [class.connected]="isConnected()"></span>
                {{ isConnected() ? 'Conectado en tiempo real' : 'Desconectado' }}
              </div>
              <button class="connect-btn" (click)="toggleConnection()">
                {{ isConnected() ? '🔌 Desconectar' : '🔌 Conectar' }}
              </button>
            </div>
            
            <div class="realtime-data" *ngIf="realtimeData().length > 0">
              <h4>📊 Datos en Tiempo Real:</h4>
              @for (data of realtimeData().slice(0, 5); track data.id) {
                <div class="realtime-item">
                  <span class="timestamp">{{ data.timestamp | date:'medium' }}</span>
                  <span class="message">{{ data.message }}</span>
                </div>
              }
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Demo PROVIAS -->
    <section *ngIf="activeTab === 'provias-demo'" class="content-section">
      <div class="theory-box">
        <h2>🏛️ Demo Completo PROVIAS</h2>
        <blockquote>
          "Esta aplicación demuestra arquitectura profesional. Estado centralizado, derivaciones automáticas, persistencia transparente, UI reactiva."
          <footer>- Ing. Jhonny Ramirez</footer>
        </blockquote>
      </div>

      <div class="provias-dashboard">
        <div class="dashboard-header">
          <h3>🏛️ PROVIAS - Dashboard Unificado</h3>
          <div class="header-stats">
            <span class="stat">{{ globalState.projectsStats().total }} Proyectos</span>
            <span class="stat">{{ globalState.unreadCount() }} Notificaciones</span>
            <span class="stat">{{ globalState.onlineUsers() }} Usuarios Online</span>
          </div>
        </div>

        <div class="dashboard-content">
          <div class="projects-section">
            <h4>🏗️ Proyectos Activos</h4>
            <div class="projects-grid">
              @for (project of globalState.activeProjects().slice(0, 4); track project.id) {
                <div class="project-card" [class.selected]="project.id === globalState.activeProject()?.id">
                  <div class="project-header">
                    <strong>{{ project.name }}</strong>
                    <span class="project-status" [class]="project.status">{{ project.status }}</span>
                  </div>
                  <div class="project-details">
                    <span>📍 {{ project.location }}</span>
                    <span>💰 ${{ project.budget | number }}</span>
                    <span>📅 {{ project.deadline | date:'shortDate' }}</span>
                  </div>
                  <button class="select-project" (click)="globalState.setActiveProject(project)">
                    {{ project.id === globalState.activeProject()?.id ? '✅ Seleccionado' : '👁️ Ver' }}
                  </button>
                </div>
              }
            </div>
          </div>

          <div class="active-project-details" *ngIf="globalState.activeProject()">
            <h4>🎯 Proyecto Activo: {{ globalState.activeProject()?.name }}</h4>
            <div class="project-info">
              <div class="info-grid">
                <div class="info-item">
                  <span class="label">Estado:</span>
                  <span class="value" [class]="globalState.activeProject()?.status">
                    {{ globalState.activeProject()?.status }}
                  </span>
                </div>
                <div class="info-item">
                  <span class="label">Progreso:</span>
                  <span class="value">{{ globalState.activeProject()?.progress }}%</span>
                </div>
                <div class="info-item">
                  <span class="label">Ingenieros:</span>
                  <span class="value">{{ globalState.activeProjectEngineers().length }}</span>
                </div>
                <div class="info-item">
                  <span class="label">Presupuesto:</span>
                  <span class="value">${{ globalState.activeProject()?.budget | number }}</span>
                </div>
              </div>
              
              <div class="project-actions">
                <button class="action-btn update" (click)="updateProjectStatus()">
                  🔄 Actualizar Estado
                </button>
                <button class="action-btn assign" (click)="assignEngineer()">
                  👨‍💻 Asignar Ingeniero
                </button>
                <button class="action-btn report" (click)="generateReport()">
                  📊 Generar Reporte
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Estado Persistente -->
  <aside class="persistence-panel">
    <h3>💾 Estado Persistente</h3>
    <div class="persistence-info">
      <div class="auto-save-status">
        <span class="status-dot saving" *ngIf="globalState.isSaving()"></span>
        <span class="status-dot saved" *ngIf="!globalState.isSaving()"></span>
        {{ globalState.isSaving() ? 'Guardando...' : 'Todo guardado' }}
      </div>
      
      <div class="last-save" *ngIf="globalState.lastSaveTime()">
        Último guardado: {{ globalState.lastSaveTime() | date:'medium' }}
      </div>
      
      <button class="export-btn" (click)="exportState()">
        📤 Exportar Estado
      </button>
      <button class="import-btn" (click)="importState()">
        📥 Importar Estado
      </button>
    </div>
  </aside>
</div>